!function(e,t,i){"use strict";function s(e,t){this.init.apply(this,i.toArray(arguments))}s.prototype={init:function(e,t,s){var n={saveValidator:function(e){return e.canSave()},debug:!1,idleTimeout:20,saveThrottleEnabled:!0,saveThrottleTimeout:10,saveDebounceEnabled:!0,saveDebounceTimeout:2,saveDebounceMaximum:11};this.lastSerialized=null,this.saveThrottleTimer=null,this.saveDebounceTimer=null,this.saveDebounceBegan=null,this.idleTimer=null,this.enabled=!1,this.queuedSave=!1,this.options=n,this.options=i(n).extend(s),this.options.form=e,this.options.saver=t,this.saving=!1,this.status={idle:0,saving:1,busy:2,throttled:3,debounced:4,saveFailed:5,disabled:6},this.cachedForm(this.getFormSerialized())},isEnabled:function(){return this.enabled},enable:function(){this.resetIdleTimer(),this.enabled=!0},disable:function(){this.enabled=!1,this.disableIdleTimer()},disableIdleTimer:function(){e.clearTimeout(this.idleTimer),this.idleTimer=null},requestSave:function(e){return this.resetIdleTimer(),this.enabled?"undefined"!=typeof e&&e?this.requestQueuedSave():this.saving?(this.queuedSave=!0,this.status.busy):this.options.saveValidator(this)?this.options.saveThrottleEnabled&&this.throttleSave()?(this.resetThrottle(),this.status.throttled):this.options.saveDebounceEnabled?this.debounceSave():(this.debug("Handling Save Synchronous"),this.handleSave()):(this.debug("Save Not Needed"),this.status.saveFailed):this.status.disabled},requestQueuedSave:function(){var e=this.requestSave();return e===this.status.throttled&&(this.debug("Queuing Save"),this.queuedSave=!0),e},handleSave:function(){if(!this.enabled)return this.status.disabled;if(this.saving)return this.status.busy;this.saving=!0;var e=this,t=this.cachedForm(this.getFormSerialized()),i=function(){e.saving=!1,e.resetThrottle(),e.resetIdleTimer()};return this.options.saver(this,t,i)?this.status.saving:this.status.saveFailed},resetIdleTimer:function(){var t=this;this.idleTimer&&e.clearTimeout(this.idleTimer),this.idleTimer=setTimeout(function(){t.requestSave(),t.resetIdleTimer()},1e3*this.options.idleTimeout)},canSave:function(){return!this.cachedFormEquals(this.getFormSerialized())},debounceSave:function(){if(!this.enabled)return this.status.disabled;this.saveDebounceTimer&&e.clearTimeout(this.saveDebounceTimer),this.saveDebounceBegan||(this.saveDebounceBegan=i.now());var t=i.now()-this.saveDebounceBegan,s=1e3*this.options.saveDebounceMaximum-t,n=Math.max(0,Math.min(1e3*this.options.saveDebounceTimeout,s)),a=this;return this.options.saveDebounceMaximum||(n=this.options.saveDebounceTimeout),this.saveDebounceTimer=e.setTimeout(function(){a.debug("Debouncing Expired, Handling Save"),a.saveDebounceBegan=null,a.handleSave()},n),this.debug("Debouncing Save for "+n+"ms"),this.status.debounced},resetThrottle:function(){this.throttleSave(1e3*this.options.saveThrottleTimeout)},throttleSave:function(t){var i=this,s=null!=this.saveThrottleTimer;return null==this.saveThrottleTimer&&"undefined"!=typeof t&&(this.saveThrottleTimer=e.setTimeout(function(){i.debug("Throttle Expired"),i.saveThrottleTimer=null,i.queuedSave&&(i.debug("Handling Queued Save"),i.handleSave(),i.queuedSave=!1)},t),this.debug("Throttling Save")),s},getForm:function(){return this.options.form},getFormSerialized:function(){return this.getForm().serializeArray()},cachedForm:function(e){return"undefined"!=typeof e&&(this.lastSerialized=e),this.lastSerialized},cachedFormEquals:function(e){return i(this.cachedForm()).isEqual(e)},debug:function(t){this.options.debug&&e.console.log("SaverCoordinator: "+t)}},e.Concrete||(e.Concrete={}),e.Concrete.composer||(e.Concrete.composer={}),e.Concrete.composer.SaveCoodinator=s,t.fn.saveCoordinator=function(e,i){return this.each(function(){var n=t(this),a=new s(n,e,i);n.data("SaveCoordinator",a)})}}(this,jQuery,_);