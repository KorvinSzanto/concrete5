!function(e,t){"use strict";e.extend(e.fn,{concreteConversation:function(t){return this.each(function(){var n=e(this),a=n.data("concreteConversation");a||n.data("concreteConversation",a=new o(n,t))})}});var n={Confirm_remove_message:"Remove this message? Replies to it will not be removed.",Confirm_mark_as_spam:"Are you sure you want to flag this message as spam?",Warn_currently_editing:"Please complete or cancel the current message editing session before editing this message.",Unspecified_error_occurred:"An unspecified error occurred.",Error_deleting_message:"Something went wrong while deleting this message, please refresh and try again.",Error_flagging_message:"Something went wrong while flagging this message, please refresh and try again."};e.fn.concreteConversation.localize=function(t){e.extend(!0,n,t)};var o=function(e,t){this.publish("beforeInitializeConversation",{element:e,options:t}),this.init(e,t),this.publish("initializeConversation",{element:e,options:t})};o.fn=o.prototype={publish:function(e,n){n=n||{},n.ConcreteConversation=this,t.ConcreteEvent.publish(e,n)},init:function(n,o){var a=this;a.$element=n,a.options=e.extend({method:"ajax",paginate:!1,displayMode:"threaded",itemsPerPage:-1,activeUsers:[],uninitialized:!0},o);var i=""!=a.options.posttoken?1:0,s=a.options.paginate?1:0,r=a.options.orderBy,c=a.options.enableOrdering,l=a.options.displayPostingForm,d=a.options.enableCommentRating,m=a.options.commentRatingUserID,p=a.options.commentRatingIP,v=a.options.addMessageLabel?a.options.addMessageLabel:"",g=a.options.dateFormat,u=a.options.customDateFormat,h=a.options.blockAreaHandle,f=(a.options.maxFiles,a.options.maxFileSize,a.options.fileExtensions,a.options.attachmentsEnabled),b=a.options.attachmentOverridesEnabled;"ajax"==a.options.method?e.post(CCM_TOOLS_PATH+"/conversations/view_ajax",{cnvID:a.options.cnvID,cID:a.options.cID,blockID:a.options.blockID,enablePosting:i,itemsPerPage:a.options.itemsPerPage,addMessageLabel:v,paginate:s,displayMode:a.options.displayMode,orderBy:r,enableOrdering:c,displayPostingForm:l,enableCommentRating:d,commentRatingUserID:m,commentRatingIP:p,dateFormat:g,customDateFormat:u,blockAreaHandle:h,attachmentsEnabled:f,attachmentOverridesEnabled:b},function(n){var o=t.obj;t.obj=a,a.$element.empty().append(n);var i=t.location.hash.match(/^#cnv([0-9]+)Message[0-9]+$/);if(null!==i&&i[1]==a.options.cnvID){var s=e("a"+t.location.hash).offset();e("html, body").animate({scrollTop:s.top},800,"linear")}t.obj=o,a.attachBindings(),a.publish("conversationLoaded")}):(a.attachBindings(),a.finishSetup(),a.publish("conversationLoaded"))},mentionList:function(t,n,o){var a=this;if(n){if(a.dropdown.parent.css({top:n.y,left:n.x}),0==t.length)return a.dropdown.handle.dropdown("toggle"),a.dropdown.parent.remove(),a.dropdown.active=!1,void(a.dropdown.activeItem=-1);a.dropdown.list.empty(),t.slice(0,20).map(function(t){var n=e("<li/>"),i=e("<a/>").appendTo(n).text(t.getName());i.click(function(){ConcreteEvent.fire("ConversationMentionSelect",{obj:a,item:t},o)}),n.appendTo(a.dropdown.list)}),a.dropdown.active||(a.dropdown.active=!0,a.dropdown.activeItem=-1,a.dropdown.parent.appendTo(a.$element),a.dropdown.handle.dropdown("toggle")),a.dropdown.activeItem>=0&&a.dropdown.list.children().eq(a.dropdown.activeItem).addClass("active")}},attachSubscriptionBindings:function(){e("a[data-conversation-subscribe]").magnificPopup({type:"ajax",callbacks:{updateStatus:function(t){if("ready"==t.status){var n=e("form[data-conversation-form=subscribe]");e("button").on("click",n,function(t){t.preventDefault(),t.stopPropagation(),e.ajax({url:n.attr("action"),dataType:"json",success:function(t){t.subscribed?(e("[data-conversation-subscribe=subscribe]").hide(),e("[data-conversation-subscribe=unsubscribe]").show()):(e("[data-conversation-subscribe=unsubscribe]").hide(),e("[data-conversation-subscribe=subscribe]").show()),e.magnificPopup.close()}})})}},beforeOpen:function(){this.st.mainClass="mfp-zoom-in"}},closeOnContentClick:!0,midClick:!0})},attachBindings:function(){var o=this;o.$element.unbind(".cnv"),o.options.uninitialized&&(o.options.uninitialized=!1,ConcreteEvent.bind("ConversationMention",function(e,t){o.mentionList(t.items,t.coordinates||!1,t.bindTo||o.$element.get(0))},o.$element.get(0)),o.dropdown={},o.dropdown.parent=e("<div/>").css({position:"absolute",height:0,width:0}),o.dropdown.active=!1,o.dropdown.handle=e("<a/>").appendTo(o.dropdown.parent),o.dropdown.list=e("<ul/>").addClass("dropdown-menu").appendTo(o.dropdown.parent),o.dropdown.handle.dropdown(),ConcreteEvent.bind("ConversationTextareaKeydownUp",function(e){o.dropdown.activeItem==-1&&(o.dropdown.activeItem=o.dropdown.list.children().length),o.dropdown.activeItem-=1,o.dropdown.activeItem+=o.dropdown.list.children().length,o.dropdown.activeItem%=o.dropdown.list.children().length,o.dropdown.list.children().filter(".active").removeClass("active").end().eq(o.dropdown.activeItem).addClass("active")},o.$element.get(0)),ConcreteEvent.bind("ConversationTextareaKeydownDown",function(e){o.dropdown.activeItem+=1,o.dropdown.activeItem+=o.dropdown.list.children().length,o.dropdown.activeItem%=o.dropdown.list.children().length,o.dropdown.list.children().filter(".active").removeClass("active").end().eq(o.dropdown.activeItem).addClass("active")},o.$element.get(0)),ConcreteEvent.bind("ConversationTextareaKeydownEnter",function(e){o.dropdown.list.children().filter(".active").children("a").click()},o.$element.get(0)),ConcreteEvent.bind("ConversationPostError",function(t,n){var o=n.form,a=n.messages,i="";e.each(a,function(e,t){i+=t+"<br>"}),o.find("div.ccm-conversation-errors").html(i).show()}),ConcreteEvent.bind("ConversationSubmitForm",function(e,t){t.form.find("div.ccm-conversation-errors").hide()}));var a=o.options.paginate?1:0,i=""!=o.options.posttoken?1:0,s=o.options.addMessageLabel?o.options.addMessageLabel:"";o.$replyholder=o.$element.find("div.ccm-conversation-add-reply"),o.$newmessageform=o.$element.find("div.ccm-conversation-add-new-message form"),o.$deleteholder=o.$element.find("div.ccm-conversation-delete-message"),o.$attachmentdeleteholder=o.$element.find("div.ccm-conversation-delete-attachment"),o.$permalinkholder=o.$element.find("div.ccm-conversation-message-permalink"),o.$messagelist=o.$element.find("div.ccm-conversation-message-list"),o.$messagecnt=o.$element.find(".ccm-conversation-message-count"),o.$postbuttons=o.$element.find("[data-submit=conversation-message]"),o.$sortselect=o.$element.find("select[data-sort=conversation-message-list]"),o.$loadmore=o.$element.find("[data-load-page=conversation-message-list]"),o.$messages=o.$element.find("div.ccm-conversation-messages"),o.$messagerating=o.$element.find("span.ccm-conversation-message-rating"),o.$element.on("click.cnv","[data-submit=conversation-message]",function(t){t.preventDefault(),o.submitForm(e(this))}),o.$element.on("click.cnv","[data-submit=update-conversation-message]",function(){return o.submitUpdateForm(e(this)),!1}),this.attachSubscriptionBindings();var r=1;o.$element.on("click.cnv","a[data-toggle=conversation-reply]",function(t){t.preventDefault(),e(".ccm-conversation-attachment-container").each(function(){e(this).is(":visible")&&e(this).toggle()});var n=o.$replyholder.appendTo(e(this).closest("div[data-conversation-message-id]"));return n.attr("data-form","conversation-reply").show(),n.find("[data-submit=conversation-message]").attr("data-post-parent-id",e(this).attr("data-post-parent-id")),n.attr("rel","new-reply"+r),r++,!1}),e(".ccm-conversation-attachment-container").hide(),e(".ccm-conversation-add-new-message .ccm-conversation-attachment-toggle").off("click.cnv").on("click.cnv",function(t){t.preventDefault(),e(".ccm-conversation-add-reply .ccm-conversation-attachment-container").is(":visible")&&e(".ccm-conversation-add-reply .ccm-conversation-attachment-container").toggle(),e(".ccm-conversation-add-new-message .ccm-conversation-attachment-container").toggle()}),e(".ccm-conversation-add-reply .ccm-conversation-attachment-toggle").off("click.cnv").on("click.cnv",function(t){t.preventDefault(),e(".ccm-conversation-add-new-message .ccm-conversation-attachment-container").is(":visible")&&e(".ccm-conversation-add-new-message .ccm-conversation-attachment-container").toggle(),e(".ccm-conversation-add-reply .ccm-conversation-attachment-container").toggle()}),o.$element.on("click.cnv","a[data-submit=delete-conversation-message]",function(){var a=e(this);return o.$deletedialog=o.$deleteholder.clone(),o.$deletedialog.dialog?o.$deletedialog.dialog({modal:!0,dialogClass:"ccm-conversation-dialog",title:o.$deleteholder.attr("data-dialog-title"),buttons:[{text:o.$deleteholder.attr("data-cancel-button-title"),"class":"btn pull-left",click:function(){o.$deletedialog.dialog("close")}},{text:o.$deleteholder.attr("data-confirm-button-title"),"class":"btn pull-right btn-danger",click:function(){o.deleteMessage(a.attr("data-conversation-message-id"))}}]}):t.confirm(n.Confirm_remove_message)&&o.deleteMessage(a.attr("data-conversation-message-id")),!1}),o.$element.on("click.cnv","a[data-submit=flag-conversation-message]",function(){var a=e(this);return t.confirm(n.Confirm_mark_as_spam)&&o.flagMessage(a.attr("data-conversation-message-id")),!1}),o.$element.on("click.cnv","a[data-load=edit-conversation-message]",function(){if(e(".ccm-conversation-edit-message").is(":visible"))return t.alert(n.Warn_currently_editing),!1;var a=e(this);o.editMessage(a.attr("data-conversation-message-id"))}),o.$element.on("change.cnv","select[data-sort=conversation-message-list]",function(){o.$messagelist.load(CCM_TOOLS_PATH+"/conversations/view_ajax",{cnvID:o.options.cnvID,task:"get_messages",cID:o.options.cID,blockID:o.options.blockID,enablePosting:i,displayMode:o.options.displayMode,itemsPerPage:o.options.itemsPerPage,paginate:a,addMessageLabel:s,orderBy:e(this).val(),enableOrdering:o.options.enableOrdering,displayPostingForm:o.options.displayPostingForm,enableCommentRating:o.options.enableCommentRating,dateFormat:o.options.dateFormat,customDateFormat:o.options.customDateFormat,blockAreaHandle:o.options.blockAreaHandle,attachmentsEnabled:o.options.attachmentsEnabled,attachmentOverridesEnabled:o.options.attachmentOverridesEnabled},function(t){o.$replyholder.appendTo(o.$element),e(".ccm-conversation-messages .dropdown-toggle").dropdown(),o.attachBindings()})}),o.$element.on("click.cnv",".image-popover-hover",function(){e.magnificPopup.open({items:{src:e(this).attr("data-full-image"),type:"image",verticalFit:!0}})}),o.$element.on("click.cnv","[data-load-page=conversation-message-list]",function(){var t=parseInt(o.$loadmore.attr("data-next-page")),n=parseInt(o.$loadmore.attr("data-total-pages")),a={cnvID:o.options.cnvID,cID:o.options.cID,blockID:o.options.blockID,itemsPerPage:o.options.itemsPerPage,displayMode:o.options.displayMode,blockAreaHandle:o.options.blockAreaHandle,enablePosting:i,addMessageLabel:s,page:t,orderBy:o.$sortselect.val(),enableCommentRating:o.options.enableCommentRating,dateFormat:o.options.dateFormat,customDateFormat:o.options.customDateFormat,attachmentsEnabled:o.options.attachmentsEnabled,attachmentOverridesEnabled:o.options.attachmentOverridesEnabled};e.ajax({type:"post",data:a,url:CCM_TOOLS_PATH+"/conversations/message_page",success:function(a){o.$messages.append(a),e(".ccm-conversation-messages .dropdown-toggle").dropdown(),t+1>n?o.$loadmore.hide():o.$loadmore.attr("data-next-page",t+1)}})}),o.$element.on("click.cnv",".conversation-rate-message",function(){var t=e(this).closest("[data-conversation-message-id]").attr("data-conversation-message-id"),n=e(this).attr("data-conversation-rating-type");o.$messagerating.load(CCM_TOOLS_PATH+"/conversations/rate");var a={cnvID:o.options.cnvID,cID:o.options.cID,blockID:o.options.blockID,cnvMessageID:t,cnvRatingTypeHandle:n,commentRatingUserID:o.options.commentRatingUserID,commentRatingIP:o.options.commentRatingIP};e.ajax({type:"post",data:a,url:CCM_TOOLS_PATH+"/conversations/rate",success:function(n){e('span[data-message-rating="'+t+'"]').load(CCM_TOOLS_PATH+"/conversations/get_rating",{cnvMessageID:t})}})}),o.$element.on("click.cnv","a.share-popup",function(){var n=void 0!=t.screenLeft?t.screenLeft:screen.left,o=void 0!=t.screenTop?t.screenTop:screen.top,a=t.innerWidth?t.innerWidth:document.documentElement.clientWidth?document.documentElement.clientWidth:screen.width,i=t.innerHeight?t.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:screen.height,s=a/2-300+n,r=i/2-125+o;return t.open(e(this).attr("href"),"cnvSocialShare","left:"+s+",top:"+r+",height=250,width=600,toolbar=no,status=no"),!1}),o.$element.on("click.cnv","a.share-permalink",function(){var n=e(this),a=n.attr("rel");o.$permalinkdialog=o.$permalinkholder.clone();var i=e("<textarea readonly>").text(decodeURIComponent(a));return o.$permalinkdialog.append(i),i.click(function(){var n=e(this);n.select(),t.setTimeout(function(){n.select()},1),n.mouseup(function(){return n.unbind("mouseup"),!1})}),o.$permalinkdialog.dialog&&o.$permalinkdialog.dialog({modal:!0,dialogClass:"ccm-conversation-dialog",title:o.$permalinkholder.attr("data-dialog-title"),buttons:[{text:o.$permalinkholder.attr("data-cancel-button-title"),"class":"btn pull-left",click:function(){o.$permalinkdialog.dialog("close")}}]}),!1}),o.options.attachmentsEnabled>0&&o.$element.concreteConversationAttachments(o),e(".dropdown-toggle").dropdown()},handlePostError:function(e,t){t||(t=[n.Unspecified_error_occurred]),this.publish("conversationPostError",{form:e,messages:t})},deleteMessage:function(o){var a=this;a.publish("conversationBeforeDeleteMessage",{msgID:o});var i=[{name:"cnvMessageID",value:o}];e.ajax({type:"post",data:i,url:CCM_TOOLS_PATH+"/conversations/delete_message",success:function(t){var n=e("div[data-conversation-message-id="+o+"]");n.length&&n.after(t).remove(),a.updateCount(),a.$deletedialog.dialog&&a.$deletedialog.dialog("close"),a.publish("conversationDeleteMessage",{msgID:o})},error:function(e){a.publish("conversationDeleteMessageError",{msgID:o,error:arguments}),t.alert(n.Error_deleting_message)}})},editMessage:function(t){var n=this,o=[{name:"cnvMessageID",value:t},{name:"cID",value:this.options.cID},{name:"blockAreaHandle",value:this.options.blockAreaHandle},{name:"bID",value:this.options.blockID}];e.ajax({type:"post",data:o,url:CCM_TOOLS_PATH+"/conversations/edit_message",success:function(o){var a=e("div[data-conversation-message-id="+t+"]"),i=a;a.after(o).remove(),e(".ccm-conversation-attachment-container").hide(),e(".ccm-conversation-edit-message .ccm-conversation-attachment-toggle").off("click.cnv").on("click.cnv",function(t){t.preventDefault(),e(".ccm-conversation-edit-message .ccm-conversation-attachment-container").toggle()}),n.$editMessageHolder=n.$element.find("div.ccm-conversation-edit-message"),n.$element.concreteConversationAttachments(n),e("button.cancel-update").on("click.cnv",function(){e(".ccm-conversation-edit-message").replaceWith(i)})},error:function(e){n.publish("conversationEditMessageError",{msgID:t,error:arguments})}})},flagMessage:function(o){var a=this;a.publish("conversationBeforeFlagMessage",{msgID:o});var i=[{name:"cnvMessageID",value:o}];e.ajax({type:"post",data:i,url:CCM_TOOLS_PATH+"/conversations/flag_message",success:function(t){var n=e("div[data-conversation-message-id="+o+"]");n.length&&n.after(t).remove(),a.updateCount(),a.publish("conversationFlagMessage",{msgID:o})},error:function(e){a.publish("conversationFlagMessageError",{msgID:o,error:arguments}),t.alert(n.Error_flagging_message)}})},addMessageFromJSON:function(t,n){var o=this;o.publish("conversationBeforeAddMessageFromJSON",{json:n,form:t});var a=""!=o.options.posttoken?1:0,i=[{name:"cnvMessageID",value:n.cnvMessageID},{name:"enablePosting",value:a},{name:"displayMode",value:o.options.displayMode},{name:"enableCommentRating",value:o.options.enableCommentRating}];e.ajax({type:"post",data:i,url:CCM_TOOLS_PATH+"/conversations/message_detail",success:function(a){var i=e("div[data-conversation-message-id="+n.cnvMessageParentID+"]");if(i.length){i.after(a),o.$replyholder.appendTo(o.$element),o.$replyholder.hide(),o.$replyholder.find(".conversation-editor").val("");try{o.$replyholder.find(".redactor_conversation_editor_"+o.options.cnvID).redactor("set","")}catch(s){}}else{"date_desc"==o.options.orderBy?o.$messages.prepend(a):o.$messages.append(a),o.$element.find(".ccm-conversation-no-messages").hide(),o.$newmessageform.find(".conversation-editor").val("");try{o.$newmessageform.find(".redactor_conversation_editor_"+o.options.cnvID).redactor("set","")}catch(s){}}o.publish("conversationAddMessageFromJSON",{json:n,form:t}),o.updateCount();var r=e("a#cnv"+o.options.cnvID+"Message"+n.cnvMessageID).offset();e(".dropdown-toggle").dropdown(),e("html, body").animate({scrollTop:r.top},800,"linear")}})},updateMessageFromJSON:function(t,n){var o=this,a=""!=o.options.posttoken?1:0,i=[{name:"cnvMessageID",value:n.cnvMessageID},{name:"enablePosting",value:a},{name:"displayMode",value:o.options.displayMode},{name:"enableCommentRating",value:o.options.enableCommentRating}];e.ajax({type:"post",data:i,url:CCM_TOOLS_PATH+"/conversations/message_detail",success:function(t){var o=e("div[data-conversation-message-id="+n.cnvMessageID+"]");o.after(t).remove(),e(".dropdown-toggle").dropdown()}})},updateCount:function(){var e=this;e.publish("conversationBeforeUpdateCount"),e.$messagecnt.load(CCM_TOOLS_PATH+"/conversations/count_header",{cnvID:e.options.cnvID},function(){e.publish("conversationUpdateCount")})},submitForm:function(t){var n=this;n.publish("conversationBeforeSubmitForm");var o=t.closest("form");t.prop("disabled",!0),o.parent().addClass("ccm-conversation-form-submitted");var a=o.serializeArray(),i=t.attr("data-post-parent-id");a.push({name:"token",value:n.options.posttoken},{name:"cnvID",value:n.options.cnvID},{name:"cnvMessageParentID",value:i},{name:"enableRating",value:i}),e.ajax({dataType:"json",type:"post",data:a,url:CCM_TOOLS_PATH+"/conversations/add_message",success:function(t){return t?t.error?(n.handlePostError(o,t.errors),!1):(e(".preview.processing").each(function(){e('input[rel="'+e(this).attr("rel")+'"]').remove()}),e("form.dropzone").each(function(){var t=e(this).data("dropzone");e.each(t.files,function(e,n){t.removeFile(n)})}),n.addMessageFromJSON(o,t),void n.publish("conversationSubmitForm",{form:o,response:t})):(n.handlePostError(o),!1)},error:function(e){return n.handlePostError(o),!1},complete:function(e){t.prop("disabled",!1),o.parent().closest(".ccm-conversation-form-submitted").removeClass("ccm-conversation-form-submitted")}})},submitUpdateForm:function(t){var n=this;n.publish("conversationBeforeSubmitForm");var o=t.closest("form");t.prop("disabled",!0),o.parent().addClass("ccm-conversation-form-submitted");var a=o.serializeArray(),i=t.attr("data-post-message-id");a.push({name:"token",value:n.options.posttoken},{name:"cnvMessageID",value:i}),e.ajax({dataType:"json",type:"post",data:a,url:CCM_TOOLS_PATH+"/conversations/update_message",success:function(t){return t?t.error?(n.handlePostError(o,t.errors),!1):(e(".preview.processing").each(function(){e('input[rel="'+e(this).attr("rel")+'"]').remove()}),n.updateMessageFromJSON(o,t),void n.publish("conversationSubmitForm",{form:o,response:t})):(n.handlePostError(o),!1)},error:function(e){return n.handlePostError(o),!1},complete:function(e){t.prop("disabled",!1),o.parent().closest(".ccm-conversation-form-submitted").removeClass("ccm-conversation-form-submitted")}})},tool:{setCaretPosition:function(e,t){if(null!=e)if(e.createTextRange){var n=e.createTextRange();n.move("character",t),n.select()}else e.selectionStart?(e.focus(),e.setSelectionRange(t,t)):e.focus()},getCaretPosition:function(e){if(e.selectionStart)return e.selectionStart;if(document.selection){e.focus();var t=document.selection.createRange();if(null==t)return 0;var n=e.createTextRange(),o=n.duplicate();return n.moveToBookmark(t.getBookmark()),o.setEndPoint("EndToStart",n),o.text.length}return 0},testMentionString:function(e){return/^@[a-z0-9]+$/.test(e)},getMentionMatches:function(e,t){return t.filter(function(t){return t.indexOf(e)>=0})},isSameConversation:function(e,t){return e.options.blockID===t.options.blockID&&e.options.cnvID===t.options.cnvID},MentionUser:function(e){this.getName=function(){return e}}}}}(jQuery,window),function(e,t){var n={Too_many_files:"Too many files",Invalid_file_extension:"Invalid file extension",Max_file_size_exceeded:"Max file size exceeded",Error_deleting_attachment:"Something went wrong while deleting this attachment, please refresh and try again.",Confirm_remove_attachment:"Remove this attachment?"},o={init:function(t){var o=t;return o.$element.on("click.cnv","a[data-toggle=conversation-reply]",function(){e(".ccm-conversation-wrapper").concreteConversationAttachments("clearDropzoneQueues")}),o.$element.on("click.cnv","a.attachment-delete",function(t){t.preventDefault(),e(this).concreteConversationAttachments("attachmentDeleteTrigger",o)}),o.$editMessageHolder&&!o.$editMessageHolder.find(".dropzone").attr("data-dropzone-applied")&&o.$editMessageHolder.find(".dropzone").not('[data-drozpone-applied="true"]').dropzone({url:CCM_TOOLS_PATH+"/conversations/add_file",success:function(t,n){var a=this;e(t.previewTemplate).click(function(){a.removeFile(t),e('input[rel="'+e(this).attr("rel")+'"]').remove()});var i=JSON.parse(n);if(i.error){var s=e('.preview.processing[rel="'+i.timestamp+'"]').closest("form");o.handlePostError(s,[i.error]),e('.preview.processing[rel="'+i.timestamp+'"]').remove(),s.children(".ccm-conversation-errors").delay(3e3).fadeOut("slow",function(){e(this).html("")})}else e(this.element).closest("div.ccm-conversation-edit-message").find("form.aux-reply-form").append('<input rel="'+i.timestamp+'" type="hidden" name="attachments[]" value="'+i.id+'" />')},accept:function(t,a){var i=[],s=this.files.length;o.options.maxFiles>0&&s>o.options.maxFiles&&i.push(n.Too_many_files);var r=o.options.fileExtensions.split(",");if(t.name.split(".").pop().toLowerCase()&&r.indexOf(t.name.split(".").pop().toLowerCase())==-1&&""!=r&&i.push(n.Invalid_file_extension),o.options.maxFileSize>0&&t.size>1e6*o.options.maxFileSize&&i.push(n.Max_file_size_exceeded),i.length>0){var c=this;e('input[rel="'+e(t.previewTemplate).attr("rel")+'"]').remove();var l=e(t.previewTemplate).parent(".dropzone");c.removeFile(t),o.handlePostError(l,i),l.children(".ccm-conversation-errors").delay(3e3).fadeOut("slow",function(){e(this).html("")}),s=-1,a("error")}else a()},sending:function(t,n,a){e(t.previewTemplate).attr("rel",(new Date).getTime()),a.append("timestamp",e(t.previewTemplate).attr("rel")),a.append("tag",e(o.$editMessageHOlder).parent("div").attr("rel")),a.append("fileCount",e(o.$editMessageHolder).find('[name="attachments[]"]').length)},init:function(){e(this.element).data("dropzone",this)}}),o.$newmessageform.dropzone&&!e(o.$newmessageform).attr("data-dropzone-applied")&&(o.$newmessageform.dropzone({accept:function(t,a){var i=[],s=this.files.length;o.options.maxFiles>0&&s>o.options.maxFiles&&i.push(n.Too_many_files);var r=o.options.fileExtensions.split(",");if(t.name.split(".").pop().toLowerCase()&&r.indexOf(t.name.split(".").pop().toLowerCase())==-1&&""!=r&&i.push(n.Invalid_file_extension),o.options.maxFileSize>0&&t.size>1e6*o.options.maxFileSize&&i.push(n.Max_file_size_exceeded),i.length>0){var c=this;e('input[rel="'+e(t.previewTemplate).attr("rel")+'"]').remove();var l=e(t.previewTemplate).parent(".dropzone");c.removeFile(t),o.handlePostError(l,i),l.children(".ccm-conversation-errors").delay(3e3).fadeOut("slow",function(){e(this).html("")}),s=-1,a("error")}else a()},url:CCM_TOOLS_PATH+"/conversations/add_file",success:function(t,n){var a=this;e(t.previewTemplate).click(function(){e('input[rel="'+e(this).attr("rel")+'"]').remove(),a.removeFile(t)});var i=JSON.parse(n);if(i.error){var s=e('.preview.processing[rel="'+i.timestamp+'"]').closest("form");o.handlePostError(s,[i.error]),e('.preview.processing[rel="'+i.timestamp+'"]').remove(),s.children(".ccm-conversation-errors").delay(3e3).fadeOut("slow",function(){e(this).html("")})}else e('div[rel="'+i.tag+'"] form.main-reply-form').append('<input rel="'+i.timestamp+'" type="hidden" name="attachments[]" value="'+i.id+'" />')},sending:function(t,n,a){e(t.previewTemplate).attr("rel",(new Date).getTime()),a.append("timestamp",e(t.previewTemplate).attr("rel")),a.append("tag",e(o.$newmessageform).parent("div").attr("rel")),a.append("fileCount",this.files.length)},init:function(){e(this.element).data("dropzone",this)}}),e(o.$newmessageform).attr("data-dropzone-applied","true")),e(o.$replyholder.find(".dropzone")).attr("data-dropzone-applied")||o.$replyholder.find(".dropzone").not('[data-drozpone-applied="true"]').dropzone({url:CCM_TOOLS_PATH+"/conversations/add_file",success:function(t,n){var a=this;e(t.previewTemplate).click(function(){a.removeFile(t),e('input[rel="'+e(this).attr("rel")+'"]').remove()});var i=JSON.parse(n);if(i.error){var s=e('.preview.processing[rel="'+i.timestamp+'"]').closest("form");o.handlePostError(s,[i.error]),e('.preview.processing[rel="'+i.timestamp+'"]').remove(),s.children(".ccm-conversation-errors").delay(3e3).fadeOut("slow",function(){e(this).html("")})}else e(this.element).closest("div.ccm-conversation-add-reply").find("form.aux-reply-form").append('<input rel="'+i.timestamp+'" type="hidden" name="attachments[]" value="'+i.id+'" />')},accept:function(t,a){var i=[],s=this.files.length;o.options.maxFiles>0&&s>o.options.maxFiles&&i.push(n.Too_many_files);var r=o.options.fileExtensions.split(",");if(t.name.split(".").pop().toLowerCase()&&r.indexOf(t.name.split(".").pop().toLowerCase())==-1&&""!=r&&i.push(n.Invalid_file_extension),o.options.maxFileSize>0&&t.size>1e6*o.options.maxFileSize&&i.push(n.Max_file_size_exceeded),i.length>0){var c=this;e('input[rel="'+e(t.previewTemplate).attr("rel")+'"]').remove();var l=e(t.previewTemplate).parent(".dropzone");c.removeFile(t),o.handlePostError(l,i),l.children(".ccm-conversation-errors").delay(3e3).fadeOut("slow",function(){e(this).html("")}),s=-1,a("error")}else a()},sending:function(t,n,a){e(t.previewTemplate).attr("rel",(new Date).getTime()),a.append("timestamp",e(t.previewTemplate).attr("rel")),a.append("tag",e(o.$newmessageform).parent("div").attr("rel")),a.append("fileCount",e(o.$replyHolder).find('[name="attachments[]"]').length)},init:function(){e(this.element).data("dropzone",this)}}),e(o.$replyholder.find(".dropzone")).attr("data-dropzone-applied","true"),e.each(e(this),function(t,n){e(this).find(".ccm-conversation-attachment-container").each(function(){e(this).is(":visible")&&e(this).toggle()})})},attachmentDeleteTrigger:function(o){var a=o,i=e(this);return a.$attachmentdeletetdialog=a.$attachmentdeleteholder.clone(),a.$attachmentdeletetdialog.dialog?a.$attachmentdeletetdialog.dialog({modal:!0,dialogClass:"ccm-conversation-dialog",title:a.$attachmentdeletetdialog.attr("data-dialog-title"),buttons:[{text:a.$attachmentdeleteholder.attr("data-cancel-button-title"),"class":"btn pull-left",click:function(){a.$attachmentdeletetdialog.dialog("close")}},{text:a.$attachmentdeleteholder.attr("data-confirm-button-title"),"class":"btn pull-right btn-danger",click:function(){e(this).concreteConversationAttachments("deleteAttachment",{cnvMessageAttachmentID:i.attr("rel"),cnvObj:a,dialogObj:a.$attachmentdeletetdialog})}}]}):t.confirm(n.Confirm_remove_attachment)&&e(this).concreteConversationAttachments("deleteAttachment",{cnvMessageAttachmentID:i.attr("rel"),cnvObj:a,dialogObj:a.$attachmentdeletetdialog}),!1},clearDropzoneQueues:function(){e(".preview.processing").each(function(){e('input[rel="'+e(this).attr("rel")+'"]').remove()}),e("form.dropzone").each(function(){var t=e(this).data("dropzone");e.each(t.files,function(e,n){t.removeFile(n)})})},deleteAttachment:function(o){var a=o.cnvMessageAttachmentID,i=o.cnvObj,s=o.dialogObj,r=[{name:"cnvMessageAttachmentID",value:a}];e.ajax({type:"post",data:r,url:CCM_TOOLS_PATH+"/conversations/delete_file",success:function(t){var n=JSON.parse(t);e('p[rel="'+n.attachmentID+'"]').parent(".attachment-container").fadeOut(300,function(){e(this).remove()}),s.dialog&&(s.dialog("close"),i.publish("conversationDeleteAttachment",{cnvMessageAttachmentID:a}))},error:function(e){i.publish("conversationDeleteAttachmentError",{cnvMessageAttachmentID:a,error:arguments}),t.alert(n.Error_deleting_attachment)}})}};e.fn.concreteConversationAttachments=function(t){return o[t]?o[t].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof t&&t?void e.error("Method "+t+" does not exist on concreteConversationAttachments"):o.init.apply(this,arguments)},e.fn.concreteConversationAttachments.localize=function(t){e.extend(!0,n,t)}}(jQuery,window);