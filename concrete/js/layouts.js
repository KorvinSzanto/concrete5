!function(t,e){e.fn.concreteLayout=function(t){return this.each(function(){var e=$(this),i=e.data("concreteLayout");i||e.data("concreteLayout",i=new o(this,t))})};var o=function(t,e){this.options=$.extend({toolbar:"#ccm-layouts-toolbar",btnsave:"#ccm-layouts-save-button",btncancel:"#ccm-layouts-cancel-button",editing:!1,supportsgrid:!1,gridrowtmpid:"ccm-theme-grid-temp",additionalGridColumnClasses:""},e),this.$element=$(t),this.$toolbar=$(this.options.toolbar),this._setupDOM(),this._setupToolbarView(),this._setupFormSaveAndCancel(),this._setupFormEvents(),this._updateChooseTypeForm()};o.prototype._setupDOM=function(){this.$formviews=this.$toolbar.find("li[data-grid-form-view]"),this.$formviewcustom=this.$toolbar.find("li[data-grid-form-view=custom]"),this.$formviewthemegrid=this.$toolbar.find("li[data-grid-form-view=themegrid]"),this.$selectgridtype=this.$toolbar.find("select[name=gridType]"),this.$selectcolumnscustom=this.$toolbar.find("input[type=text][name=columns]"),this.$customspacing=this.$toolbar.find("input[name=spacing]"),this.$customautomatedfrm=this.$toolbar.find("input[name=isautomated]"),this.$customautomated=this.$toolbar.find("[data-layout-button=toggleautomated]"),this.$selectgridcolumns=this.$toolbar.find("input[type=text][name=themeGridColumns]"),this.$savebtn=this.$toolbar.find(this.options.btnsave),this.$cancelbtn=this.$toolbar.find(this.options.btncancel),this.$slider=!1},o.prototype._setupFormSaveAndCancel=function(){var t=this;this.$cancelbtn.unbind().on("click",function(){t.$toolbar.remove(),ConcreteEvent.unsubscribe("EditModeExitInlineComplete.layouts"),ConcreteEvent.on("EditModeExitInlineComplete.layouts",function(e,i){t._rescanAreasInPage(e,i)}),ConcreteEvent.fire("EditModeExitInline")}),this.$savebtn.unbind().on("click",function(){Concrete.event.fire("EditModeExitInlineSaved"),t.$toolbar.hide().prependTo("#ccm-block-form"),$("#ccm-block-form").submit(),ConcreteEvent.unsubscribe("EditModeExitInlineComplete.layouts"),ConcreteEvent.on("EditModeExitInlineComplete.layouts",function(e,i){t._rescanAreasInPage(e,i)})})},o.prototype._rescanAreasInPage=function(t,e){var i=Concrete.getEditMode();i.reset(),i.scanBlocks()},o.prototype._setupToolbarView=function(){var t=this;this.$formviews.each(function(e){$(this).attr("data-grid-form-view")!=t.options.formview&&$(this).hide()})},o.prototype._updateChooseTypeForm=function(){var t=this.$selectgridtype.find("option:selected").val(),i=this;switch(i.options.editing&&i.$selectgridtype.prop("disabled",!0),t){case"FF":this.$formviewthemegrid.hide(),this.$formviewcustom.show(),this._updateCustomView();break;case"TG":this.$formviewcustom.hide(),this.$formviewthemegrid.show(),this._updateThemeGridView();break;default:if(this.options.editing)return;var o=t;this._resetSlider(),e.fn.dialog.showLoader();var s=CCM_DISPATCHER_FILENAME+"/ccm/system/dialogs/area/layout/presets/get/"+CCM_CID+"/"+o;$.getJSON(s,function(t){i.$formviewthemegrid.hide(),i.$formviewcustom.hide(),i.$element.html(t.html),i.$element.append($("<input />",{name:"arLayoutPresetID",type:"hidden",value:o})),e.fn.dialog.hideLoader()})}},o.prototype._setupFormEvents=function(){var t=this;this.$selectcolumnscustom.on("keyup",function(){t._updateCustomView()}),this.$customspacing.on("keyup",function(){t._updateCustomView()}),this.$customautomatedfrm.on("change",function(){t._updateCustomView()}),this.$customautomated.on("click",function(){return $(this).parent().hasClass("ccm-inline-toolbar-icon-selected")?($(this).parent().removeClass("ccm-inline-toolbar-icon-selected"),t.$customautomatedfrm.val(0)):($(this).parent().addClass("ccm-inline-toolbar-icon-selected"),t.$customautomatedfrm.val(1)),t.$customautomatedfrm.trigger("change"),!1}),this.$selectgridcolumns.on("keyup",function(){t._updateThemeGridView()}),this.$selectgridtype.on("change",function(){t._updateChooseTypeForm()})},o.prototype.buildThemeGridGrid=function(){this.$element.html("");var t=this.options.rowstart;t+='<div id="ccm-theme-grid-edit-mode-row-wrapper">';var e=this._getThemeGridColumnSpan(this.columns);$.each(e,function(e,i){var o='<div id="ccm-edit-layout-column-'+e+'" class="'+i.cssClass+' ccm-theme-grid-column" data-offset="0" data-span="'+i.value+'"><div class="ccm-layout-column-highlight"><input type="hidden" id="ccm-edit-layout-column-offset-'+e+'" name="offset['+e+']" value="0" /><input type="hidden" id="ccm-edit-layout-column-span-'+e+'" name="span['+e+']" value="'+i.value+'" /></div></div>';t+=o}),t+="</div>",t+=this.options.rowend,this.$element.append(t)},o.prototype._updateThemeGridView=function(t){t||this.$selectgridtype.find("option[value=TG]").prop("selected",!0),this.columns=parseInt(this.$selectgridcolumns.val()),this.maxcolumns=parseInt(this.$selectgridcolumns.attr("data-maximum")),this.options.editing?this.$selectgridcolumns.prop("disabled",!0):this.buildThemeGridGrid(),this._resetSlider(),this.columns>1&&this._showThemeGridSlider()},o.prototype._buildThemeGridGridFromPresetColumns=function(t){this.$element.html("");var e=this.options.rowstart;e+='<div id="ccm-theme-grid-edit-mode-row-wrapper">',$.each(t,function(t,i){var o='<div id="ccm-edit-layout-column-'+t+'" class="ccm-theme-grid-column" data-offset="'+i.arLayoutColumnOffset+'" data-span="'+i.arLayoutColumnSpan+'"><div class="ccm-layout-column-highlight"><input type="hidden" id="ccm-edit-layout-column-offset-'+t+'" name="offset['+t+']" value="'+i.arLayoutColumnOffset+'" /><input type="hidden" id="ccm-edit-layout-column-span-'+t+'" name="span['+t+']" value="'+i.arLayoutColumnSpan+'" /></div></div>';e+=o}),e+="</div>",e+=this.options.rowend,this.$element.append(e),this.columns=t.length,this.maxcolumns=parseInt(this.$selectgridcolumns.attr("data-maximum")),this._resetSlider(),this._redrawThemeGrid(),this._showThemeGridSlider()},o.prototype._updateCustomView=function(t){for(t||this.$selectgridtype.find("option[value=FF]").prop("selected",!0),this.columns=parseInt(this.$selectcolumnscustom.val()),this.customspacing=this.$customspacing.val(),this.automatedcustomlayout=1==this.$customautomatedfrm.val(),this.columnwidths=[],this.options.editing&&this.$selectcolumnscustom.prop("disabled",!0),this.options.editing||this.$element.html(""),i=0;i<this.columns;i++)if(!(this.options.editing&&$("#ccm-edit-layout-column-"+i).length>0)){var e=$("<div />").attr("class","ccm-layout-column");e.attr("id","ccm-edit-layout-column-"+i);var o=$("<div />").attr("class","ccm-layout-column-highlight");o.append($("<input />",{name:"width["+i+"]",type:"hidden",id:"ccm-edit-layout-column-width-"+i})),e.append(o),this.$element.append(e)}var s=this.$element.find(".ccm-layout-column");if(this.columns<s.length)for(i=columns;i<s.length;i++)$("#ccm-edit-layout-column-"+i).remove();for(i=0;i<this.columns;i++){if(o=$("#ccm-edit-layout-column-"+i+" .ccm-layout-column-highlight"),i>0&&o.css("margin-left",this.customspacing/2+"px"),i+1<this.columns&&o.css("margin-right",this.customspacing/2+"px"),e=$("#ccm-edit-layout-column-"+i),e.attr("data-width")){var a=e.attr("data-width")+"px";this.columnwidths.push(parseInt(e.attr("data-width")))}else var a=100/this.columns+"%";e.css("width",a)}this._resetSlider(),!this.automatedcustomlayout&&this.columns>1&&this._showCustomSlider()},o.prototype._resetSlider=function(){this.$slider&&(this.$slider.slider("destroy"),this.$slider=!1),$("#ccm-area-layout-active-control-bar").hasClass("ccm-area-layout-control-bar-add")&&$("#ccm-area-layout-active-control-bar").css("height","0px")},o.prototype._getThemeGridColumnSpan=function(t){var e,i=Math.ceil(this.maxcolumns/t),o=[];for(e=0;e<t;e++)o[e]=i;var s=i*t;for(e=0;e<s-this.maxcolumns;e++){var a=o.length-e-1;o[a]--}var n=[];for(e=0;e<o.length;e++)n[e]={},n[e].cssClass=this.options.gridColumnClasses[o[e]-1],this.options.additionalGridColumnClasses&&(n[e].cssClass=n[e].cssClass+" "+this.options.additionalGridColumnClasses),n[e].value=o[e];return n},o.prototype._getThemeGridNearestValue=function(t,e){var i=null;return $.each(e,function(){(null==i||Math.abs(this-t)<Math.abs(i-t))&&(i=this)}),i},o.prototype._showThemeGridSlider=function(){var t=this;t.$slider=$("#ccm-area-layout-active-control-bar"),t.$slider.css("height","6px");var e=[];for(u=0;u<t.columns;u++)h=$("#ccm-edit-layout-column-"+u),0==u?e.push(Math.floor(h.width())):u+1==t.columns?e.push(Math.floor(h.position().left)):(e.push(Math.floor(h.position().left)),e.push(Math.floor(h.width())+Math.floor(h.position().left)));var i=$("#ccm-area-layout-active-control-bar").width(),o=[],s=[],a=t.options.maxcolumns,n=t.options.gridColumnClasses[0],r=$("#ccm-theme-grid-edit-mode-row-wrapper").closest(".ccm-block-edit-layout, .ccm-layouts-edit-mode-add");r.length||(r=$("#ccm-theme-grid-edit-mode-row-wrapper"));var l=$("<div />",{id:t.options.gridrowtmpid}).appendTo(r),c="";for(u=1;u<=a;u++)c+=t.options.additionalGridColumnClasses?'<div class="'+n+" "+t.options.additionalGridColumnClasses+'"><br><br></div>':'<div class="'+n+'"><br><br></div>';var d=t.options.rowstart+c+t.options.rowend;l.append($(d));for(var m=0,u=0;u<a;u++){var h=l.find("."+n).eq(u);if(0==u){var p=h.position().left;p<0&&(m=Math.abs(p))}o.push(Math.floor(h.position().left+m)),s.push(Math.floor(Math.floor(h.width())+Math.floor(h.position().left)+m))}l.remove(),t.$slider.slider({min:0,max:i,step:1,values:e,slide:function(i,a){"TG"!=t.$selectgridtype.val()&&t.$selectgridtype.find("option[value=TG]").prop("selected",!0);var n,r=$(a.handle).index();n=r%2==0?s:o;for(var l=0;l<e.length;l++)for(var c=0;c<n.length;c++){var d=Math.abs(e[l]-n[c]);d<=2&&(n[c]=e[l])}var m=t.$slider.slider("values",r),u=t._getThemeGridNearestValue(a.value,n),h=!0;if($.each(a.values,function(t,e){u>=e&&r<t?h=!1:u<=e&&r>t&&(h=!1)}),h&&m==u&&(h=!1),h){if(t.$slider.slider("values",r,u),r%2==0){g=Math.floor(r/2),$innercolumn=$("#ccm-edit-layout-column-"+g);var p=parseInt($innercolumn.attr("data-span")),f=$innercolumn.nextAll(".ccm-theme-grid-column:first"),v=f.attr("data-offset");v=v?parseInt(v):0,u>m?(p++,v--):(p--,v++)}else{var g=Math.ceil(r/2);$innercolumn=$("#ccm-edit-layout-column-"+g);var p=parseInt($innercolumn.attr("data-span")),f=$innercolumn,v=f.attr("data-offset");v=v?parseInt(v):0,u<m?(p++,v--):(p--,v++)}f.attr("data-offset",v),$innercolumn.attr("data-span",p),t._redrawThemeGrid()}return!1}})},o.prototype._redrawThemeGrid=function(){var t=this;t.$element.find(".ccm-theme-grid-offset-column").remove(),$.each(t.$element.find(".ccm-theme-grid-column"),function(e,i){var o=$(i);if(o.removeClass(),o.attr("data-span")){var s=parseInt(o.attr("data-span"))-1;o.addClass(t.options.gridColumnClasses[s]),t.options.additionalGridColumnClasses&&o.addClass(t.options.additionalGridColumnClasses)}if(parseInt(o.attr("data-offset"))>0){var a=parseInt(o.attr("data-offset"))-1,n=t.options.gridColumnClasses[a]+" ccm-theme-grid-offset-column";t.options.additionalGridColumnOffsetClasses&&(n=n+" "+t.options.additionalGridColumnOffsetClasses),$("<div />",{"data-offset-column":!0}).html("&nbsp;").addClass(n).insertBefore(o)}$("#ccm-edit-layout-column-offset-"+e).val(parseInt(o.attr("data-offset"))),$("#ccm-edit-layout-column-span-"+e).val(parseInt(o.attr("data-span"))),o.addClass("ccm-theme-grid-column"),t.options.editing&&o.addClass("ccm-theme-grid-column-edit-mode")})},o.prototype._showCustomSlider=function(){this.$slider=$("#ccm-area-layout-active-control-bar"),this.$slider.css("height","6px");var t,e=[],i=0,o=Math.floor(this.$slider.width()),s=this.$element.find(".ccm-layout-column");if(this.columnwidths.length>0)for(t=0;t<this.columnwidths.length-1;t++)i+=this.columnwidths[t],e.push(i);else{var a=o/this.columns;for(t=1;t<this.columns;t++)i+=a,e.push(i)}var n=this;this.$slider.slider({min:0,max:o,step:1,values:e,create:function(t,i){var a=0;$.each(s,function(t,i){var n,r=e[t];n=t+1==s.length?o-a:r-a,n=Math.floor(n),$(i).find("#ccm-edit-layout-column-width-"+t).val(n),a=r})},slide:function(t,e){"FF"!=n.$selectgridtype.val()&&n.$selectgridtype.find("option[value=FF]").prop("selected",!0);var i=0,a=!0;return $.each(e.values,function(t,e){e<i&&(a=!1),i=e}),!!a&&(i=0,void $.each(s,function(t,a){var n;n=t+1==s.length?o-i:e.values[t]-i,n=Math.floor(n),$(a).find("#ccm-edit-layout-column-width-"+t).val(n),$(a).css("width",n+"px"),i=e.values[t]}))}})}}(this,jQuery);