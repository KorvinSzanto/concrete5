!function(e,t,r){"use strict";function o(e,r){var n=this;return r=r||{},r=t.extend({readOnly:!1,chooseNodeInForm:!1,onSelect:!1,treeID:!1,onClick:!1,allowFolderSelection:!0,selectNodesByKey:[],removeNodesByKey:[],removeNodesByCallback:!1,ajaxData:{}},r),n.options=r,n.$element=e,n.setupTree(),o.setupTreeEvents(n),n.$element}o.prototype={dragRequest:function(e,r,o){var n=r.parent.data.treeNodeID;"over"==o&&(n=r.data.treeNodeID),jQuery.fn.dialog.showLoader();var a=[{name:"sourceTreeNodeID",value:e.data.treeNodeID},{name:"treeNodeParentID",value:n}],d=r.parent.getChildren();if(d)for(var c=0;c<d.length;c++){var i=d[c];a.push({name:"treeNodeID[]",value:i.data.treeNodeID})}t.concreteAjax({data:a,url:CCM_DISPATCHER_FILENAME+"/ccm/system/tree/node/drag_request"})},setupTree:function(){var e=this,r=e.options,o={},n=!1,a={};0!=e.options.ajaxData&&(a=e.options.ajaxData),r.treeNodeParentID?a.treeNodeParentID=r.treeNodeParentID:a.treeID=r.treeID,r.allowFolderSelection&&(a.allowFolderSelection=1);var d=!0;r.chooseNodeInForm&&(n=!0,d=!1,o={checkbox:"fancytree-radio"},r.selectNodesByKey.length&&(a.treeNodeSelectedIDs=r.selectNodesByKey)),"multiple"===r.chooseNodeInForm&&(n=!0,d=!1,o={checkbox:"fancytree-checkbox"},r.selectNodesByKey.length&&(a.treeNodeSelectedIDs=r.selectNodesByKey));var c=1;r.selectMode&&(c=r.selectMode);var i=2;if(r.minExpandLevel&&(i=r.minExpandLevel),r.treeNodeParentID)var s=CCM_DISPATCHER_FILENAME+"/ccm/system/tree/node/load_starting";else var s=CCM_DISPATCHER_FILENAME+"/ccm/system/tree/load";t(e.$element).fancytree({extensions:["glyph","dnd"],glyph:{map:{doc:"fa fa-file-o",docOpen:"fa fa-file-o",checkbox:"fa fa-square-o",checkboxSelected:"fa fa-check-square-o",checkboxUnknown:"fa fa-share-square",dragHelper:"fa fa-share",dropMarker:"fa fa-angle-right",error:"fa fa-warning",expanderClosed:"fa fa-plus-square-o",expanderLazy:"fa fa-plus-square-o",expanderOpen:"fa fa-minus-square-o",loading:"fa fa-spin fa-refresh"}},source:{url:s,type:"post",data:a},lazyLoad:function(t,r){r.result=e.getLoadNodePromise(r.node)},select:function(e,o){if(r.chooseNodeInForm){var n=t.map(o.tree.getSelectedNodes(),function(e){return e.key});r.onSelect(n)}},selectMode:c,checkbox:n,minExpandLevel:i,clickFolderMode:1,init:function(){var o=e.$element;if(r.removeNodesByKey.length)for(var n=0;n<r.removeNodesByKey.length;n++){var a=r.removeNodesByKey[n],d=o.fancytree("getTree").getNodeByKey(a);d&&d.remove()}if(r.readOnly&&o.fancytree("disable"),r.chooseNodeInForm){var c=o.fancytree("getTree");if(c=c.getSelectedNodes(),c.length){var i=t.map(c,function(e){return e.key});r.onSelect(i)}}if(c){t.map(c,function(e){e.makeVisible()})}},click:function(e,o){if("expander"==o.targetType)return!0;if(r.onClick)return r.onClick(o.node,e);if(r.chooseNodeInForm&&"checkbox"!=o.targetType)return!1;if(!o.targetType)return!1;if(!r.chooseNodeInForm&&e.originalEvent.target&&t(e.originalEvent.target).hasClass("fancytree-title")){var n=o.node.data.treeNodeMenu;if(n){var a=new ConcreteMenu(t(o.node.span),{menu:n,handle:"none"});a.show(e)}}return!0},dnd:{preventRecursiveMoves:!0,focusOnClick:!0,preventVoidMoves:!0,dragStart:function(e,t){return!r.chooseNodeInForm},dragStop:function(e,t){return!0},dragEnter:function(e,t){var r=t.otherNode,o=t.hitMode;return!(!e.parent.data.treeNodeID&&"1"!==e.data.treeNodeID)&&(("over"==o||1!=e.data.treeNodeID)&&(r.data.treeNodeID!=e.data.treeNodeID&&(!(!e.data.treeNodeID&&"after"==o)&&!e.isDescendantOf(r))))},dragDrop:function(t,r){r.otherNode.moveTo(t,r.hitMode),e.dragRequest(r.otherNode,t,r.hitMode)}}})},getLoadNodePromise:function(e){var r=this,o=(r.options,0!=r.options.ajaxData?r.options.ajaxData:{});return o.treeNodeParentID=e.data.treeNodeID,t.when(t.getJSON(CCM_DISPATCHER_FILENAME+"/ccm/system/tree/node/load",o))},reloadNode:function(e,t){this.getLoadNodePromise(e).done(function(r){e.removeChildren(),e.addChildren(r),e.setExpanded(!0,{noAnimation:!0}),t&&t()})},cloneNode:function(e){var r=this,o=t("[data-tree="+r.options.treeID+"]");return t.ajax({dataType:"json",type:"post",data:{treeNodeID:e},url:CCM_DISPATCHER_FILENAME+"/ccm/system/tree/node/duplicate",success:function(e){if(1==e.error)ConcreteAlert.dialog(ccmi18n.error,e.errors.join("<br>"));else{jQuery.fn.dialog.closeTop();var t=o.fancytree("getTree").getNodeByKey(e.treeNodeParentID);jQuery.fn.dialog.showLoader(),r.reloadNode(t,function(){jQuery.fn.dialog.hideLoader()})}},error:function(e){ConcreteAlert.dialog(ccmi18n.error,'<div class="alert alert-danger">'+e.responseText+"</div>")},complete:function(){jQuery.fn.dialog.hideLoader()}}),!1}},o.setupTreeEvents=function(e){ConcreteEvent.subscribe("ConcreteMenuShow",function(r,o){var n=o.menuElement;n.find("a[data-tree-action]").on("click.concreteMenu",function(r){r.preventDefault();var o=t(this).attr("data-tree-action-url"),n=t(this).attr("data-tree-action"),a=t(this).attr("dialog-title"),d=t(this).attr("dialog-width"),c=t(this).attr("dialog-height");switch(n){case"clone-node":e.cloneNode(t(this).attr("data-tree-node-id"));break;default:if(!a)switch(n){case"add-node":a=ccmi18n_tree.add;break;case"edit-node":a=ccmi18n_tree.edit;break;case"delete-node":a=ccmi18n_tree["delete"]}d||(d=550),c||(c="auto"),jQuery.fn.dialog.open({title:a,href:o,width:d,modal:!0,height:c})}})}),ConcreteEvent.subscribe("ConcreteTreeAddTreeNode.concreteTree",function(r,o){var n=t("[data-tree="+e.options.treeID+"]"),a=o.node;if(a.length)for(var d=0;d<a.length;d++){var c=n.fancytree("getTree").getNodeByKey(a[d].treeNodeParentID);c.addChildren(a)}else{var c=n.fancytree("getTree").getNodeByKey(a.treeNodeParentID);c.addChildren(a)}}),ConcreteEvent.subscribe("ConcreteTreeUpdateTreeNode.concreteTree",function(r,o){var n=t("[data-tree="+e.options.treeID+"]"),a=n.fancytree("getTree").getNodeByKey(o.node.key);a.fromDict(o.node),a.render()}),ConcreteEvent.subscribe("ConcreteTreeDeleteTreeNode.concreteTree",function(r,o){var n=t("[data-tree="+e.options.treeID+"]"),a=n.fancytree("getTree").getNodeByKey(o.node.treeNodeID);a.remove()})},t.fn.concreteTree=function(e){return t.each(t(this),function(r,n){new o(t(this),e)})},e.ConcreteTree=o}(this,$,_);